

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>KMS authentication &mdash; confidant 5.2.0-6dca37 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/confidant.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Threat model" href="threat_model.html" />
    <link rel="prev" title="Server-blinded secrets" href="blind_secrets.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="contents.html" class="icon icon-home"> confidant
          

          
          </a>

          
            
            
              <div class="version">
                5.2.0-6dca37
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="install.html#quickstart-for-testing">Quickstart for testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html#docker-installation">Docker installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="install.html#to-run-confidant-in-docker">To run confidant in Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#to-build-the-image">To build the image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="install.html#pip-installation">pip installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="install.html#make-a-virtualenv-and-install-pip-requirements">Make a virtualenv and install pip requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="install.html#manual-installation">Manual installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="install.html#clone-confidant">Clone Confidant</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#id1">Make a virtualenv and install pip requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#build-the-frontend">Build the frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#run-confidant">Run confidant</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#docker-vs-bash">Docker vs bash</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#basic-environment-configuration">Basic environment configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#gunicorn-configuration-for-ssl-termination-support">gunicorn configuration for SSL termination support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#google-authentication-configuration">Google authentication configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#saml-authentication-configuration">SAML authentication configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#user-authentication-session-settings">User authentication session settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#disabling-credential-conflict-checks">Disabling credential conflict checks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#advanced-environment-configuration">Advanced environment configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#statsd-metrics">statsd metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#sending-graphite-events">Sending graphite events</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#google-authentication-user-restrictions">Google authentication user restrictions</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#auth-token-lifetime">Auth token lifetime</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#frontend-configuration">Frontend configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#development-and-testing-settings">Development and testing settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#bootstrapping-confidant-s-own-secrets">Bootstrapping Confidant’s own secrets</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#multi-account-authentication">Multi-account authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#kms-authentication-for-end-users">KMS authentication for end-users</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#kms-grant-management">KMS grant management</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#confidant-client-configuration">Confidant client configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#maintenance-mode-settings">Maintenance mode settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#confidant-performance-settings">Confidant performance settings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#kms-key-policy-configuration">KMS key policy configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#confidant-iam-role-configuration">Confidant IAM role configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#confidant-dynamodb-table-configuration">Confidant DynamoDB table configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using_confidant.html">Managing secrets and mappings</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using_confidant.html#using-the-resources-view">Using the resources view</a><ul>
<li class="toctree-l3"><a class="reference internal" href="using_confidant.html#creating-secrets">Creating secrets</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_confidant.html#mapping-secrets-to-services">Mapping secrets to services</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_confidant.html#finding-credentials-and-services-in-the-sidebar">Finding credentials and services in the sidebar</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="using_confidant.html#using-the-history-view">Using the history view</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Using the Confidant client</a><ul>
<li class="toctree-l2"><a class="reference internal" href="client.html#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="client.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="client.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="client.html#reformatting-get-service-output">Reformatting get_service output</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Advanced</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="acls.html">Access Controls (ACLs)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="acls.html#design">Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="acls.html#acl-hookpoints">ACL Hookpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="acls.html#credentials">Credentials</a><ul>
<li class="toctree-l4"><a class="reference internal" href="acls.html#list-credentials">List credentials</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#get-credential-metadata">Get credential metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#get-credential">Get credential</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#create-credential">Create credential</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#update-credential">Update credential</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#id1">Revert credential</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="acls.html#services">Services</a><ul>
<li class="toctree-l4"><a class="reference internal" href="acls.html#list-services">List services</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#get-service-metadata">Get service metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#get-service">Get service</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#create-service">Create service</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#update-service">Update service</a></li>
<li class="toctree-l4"><a class="reference internal" href="acls.html#id3">Revert service</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="blind_secrets.html">Server-blinded secrets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="blind_secrets.html#what-are-server-blinded-secrets">What are server-blinded secrets?</a></li>
<li class="toctree-l2"><a class="reference internal" href="blind_secrets.html#kms-keys-and-iam-policy-examples-for-server-blinded-secrets">KMS keys and IAM policy examples for server-blinded secrets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="blind_secrets.html#creating-and-updating-server-blinded-secrets-using-the-confidant-client">Creating and updating server-blinded secrets using the confidant client</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">KMS authentication</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#service-to-service-authentication">Service-to-service authentication</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#iam-policy-configuration-for-service-to-service-auth">IAM policy configuration for service-to-service auth</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#passing-encrypted-data-between-services">Passing encrypted data between services</a></li>
<li class="toctree-l2"><a class="reference internal" href="#user-to-service-authentication">User-to-service authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multi-account-kms-authentication">Multi-account KMS authentication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="threat_model.html">Threat model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="threat_model.html#web-client-threat-model">Web client threat model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#assumptions">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-an-authenticated-user-can-achieve">What an authenticated user can achieve</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-compromise-of-an-authenticated-user-s-computer-can-achieve">What compromise of an authenticated user’s computer can achieve</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-an-unauthenticated-local-network-attacker-who-can-observe-network-traffic-can-achieve">What an unauthenticated local network attacker who can observe network traffic can achieve</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-an-unauthenticated-attacker-from-the-internet-can-achieve">What an unauthenticated attacker from the Internet can achieve</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="threat_model.html#web-server-threat-model">Web server threat model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#id1">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-an-attacker-can-achieve-through-compromise-of-the-confidant-web-server">What an attacker can achieve through compromise of the Confidant web server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="threat_model.html#service-client-threat-model">Service client threat model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#id2">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-the-service-can-achieve">What the service can achieve</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-an-attacker-can-achieve-with-a-filesystem-read-vulnerability">What an attacker can achieve with a filesystem read vulnerability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="threat_model.html#storage-threat-model">Storage threat model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#id3">Assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="threat_model.html#what-an-attacker-with-dynamodb-access-can-achieve">What an attacker with DynamoDB access can achieve</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#code-of-conduct">Code of conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#contributing-code">Contributing code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#sign-the-contributor-license-agreement-cla">Sign the Contributor License Agreement (CLA)</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#file-issues-in-github">File issues in Github</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#submit-pull-requests">Submit pull requests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#development-guide">Development guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#development-using-docker">Development using docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#quickstart-for-testing-or-development">Quickstart for testing or development</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data_schema.html">DynamoDB Data Schema</a><ul>
<li class="toctree-l2"><a class="reference internal" href="data_schema.html#at-rest-encryption-model">At-rest encryption model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrading</a><ul>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html#upgrading-to-2-0-0-or-3-0-0">Upgrading to 2.0.0 or 3.0.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="upgrade.html#performing-the-data-migration">Performing the data migration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html#upgrading-to-4-0-0">Upgrading to 4.0.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="upgrade.html#peforming-the-data-migration-for-4-0-0">Peforming the data migration for 4.0.0</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id1">6.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id2">5.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id3">5.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id4">5.0.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id5">5.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id6">4.4.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id7">4.3.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id8">4.3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id9">4.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id10">4.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id11">4.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id12">3.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id13">2.0.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id14">2.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id15">1.11.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id16">1.10.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id17">1.10.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html#id18">1.9.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id19">1.8.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id20">1.7.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id21">1.6.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id22">1.5.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id23">1.5.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id24">1.4.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id25">1.3.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id26">1.2.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id27">1.1.21</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id28">1.1.20</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id29">1.1.19</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id30">1.1.16 - 1.1.18</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id31">1.1.15</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id32">1.1.14</a></li>
<li class="toctree-l3"><a class="reference internal" href="changelog.html#id33">1.1.13</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Communication</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_reporting.html">Reporting security vulnerabilities</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="contents.html">confidant</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="contents.html">Docs</a> &raquo;</li>
        
      <li>KMS authentication</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/kms_auth.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kms-authentication">
<h1>KMS authentication<a class="headerlink" href="#kms-authentication" title="Permalink to this headline">¶</a></h1>
<div class="section" id="service-to-service-authentication">
<h2>Service-to-service authentication<a class="headerlink" href="#service-to-service-authentication" title="Permalink to this headline">¶</a></h2>
<p>When a service is created in Confidant, Confidant, by default, will generate a
couple of grants on the AUTH_KEY KMS key. One grant allows the service to do
encryptions or decryptions using the key, as long as the ‘from’ encryption context
is the name of the service and the ‘user_type’ is ‘service’; the other grant allows
the service to do decryptions using the key, as long as the ‘to’ encryption context
is the name of the service. This is what enables the services to get their secrets
from Confidant.</p>
<p>This guide is mostly going to be a crash-course on how KMS works, since we’re
just leveraging it for authentication. If you’re not very familiar with KMS,
you may want to take a look at the following docs:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/concepts.html">http://docs.aws.amazon.com/kms/latest/developerguide/concepts.html</a></p></li>
<li><p><a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/crypto-intro.html">http://docs.aws.amazon.com/kms/latest/developerguide/crypto-intro.html</a></p></li>
<li><p><a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/crypto_authen.html">http://docs.aws.amazon.com/kms/latest/developerguide/crypto_authen.html</a></p></li>
<li><p><a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/encrypt-context.html">http://docs.aws.amazon.com/kms/latest/developerguide/encrypt-context.html</a></p></li>
<li><p><a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/crypto-terminology.html">http://docs.aws.amazon.com/kms/latest/developerguide/crypto-terminology.html</a></p></li>
<li><p><a class="reference external" href="http://docs.aws.amazon.com/kms/latest/developerguide/grants.html">http://docs.aws.amazon.com/kms/latest/developerguide/grants.html</a></p></li>
</ul>
<p>Let’s take a quick look at a basic example using boto3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">not_after</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">not_before</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%SZ&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">not_after</span> <span class="o">=</span> <span class="n">not_after</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%SZ&quot;</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kms</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;kms&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plaintext</span> <span class="o">=</span> <span class="s1">&#39;{&quot;not_before&quot;: &quot;{0}&quot;, &quot;not_after&quot;: &quot;{1}&quot;}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">not_before</span><span class="p">,</span> <span class="n">not_after</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">token</span> <span class="o">=</span> <span class="n">kms</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">KeyId</span><span class="o">=</span><span class="s1">&#39;alias/authnz-testing&#39;</span><span class="p">,</span> <span class="n">Plaintext</span><span class="o">=</span><span class="n">plaintext</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">EncryptionContext</span><span class="o">=</span><span class="p">{</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;myservice-production&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;confidant-production&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;user_type&#39;</span><span class="p">:</span> <span class="s1">&#39;service&#39;</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">token</span>
<span class="go">{u&#39;KeyId&#39;: u&#39;arn:aws:kms:us-east-1:12345:key/abcdefgh-1234-5678-9abcd-ee72ac95ae8c&#39;,</span>
<span class="go">&#39;ResponseMetadata&#39;: {&#39;HTTPStatusCode&#39;: 200, &#39;RequestId&#39;:</span>
<span class="go">&#39;3a48f2ad-072d-11e5-88fb-17df9ce1a01a&#39;}, u&#39;CiphertextBlob&#39;: &#39;\n</span>
<span class="go">\x999\x9e$yO\x92\x1dg\xbbZ^S\x84\xdaI\xbf\x14@\x81\x8a\x1c\xf2\xf8Z\x05\xed\xed\xb2\x8d)T\x12\x8f\x01\x01\x01\x02\x00x\x999\x9e$yO\x92\x1dg\xbbZ^S\x84\xdaI\xbf\x14@\x81\x8a\x1c\xf2\xf8Z\x05\xed\xed\xb2\x8d)T\x00\x00\x00f0d\x06\t*\x86H\x86\xf7\r\x01\x07\x06\xa0W0U\x02\x01\x000P\x06\t*\x86H\x86\xf7\r\x01\x07\x010\x1e\x06\t`\x86H\x01e\x03\x04\x01.0\x11\x04\x0c\xd3\x96\x0c\x91\x83\xd2l!\xfb\xa6\xc2\x90\x02\x01\x10\x80#\x97Z\xd1\xbb\xb4_\x12\xea\x1a\xed\x85\x0e\x9b1\xfa0j\xca1(\xc7\xc3\x8czT\xd4\x8fk\x08\x00\xa8\xcd\xe5\x82\xb3&#39;}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kms</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">CiphertextBlob</span><span class="o">=</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;CiphertextBlob&#39;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">EncryptionContext</span><span class="o">=</span><span class="p">{</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;myservice-production&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;confidant-production&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;user_type&#39;</span><span class="p">:</span> <span class="s1">&#39;service&#39;</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
<span class="go">{u&#39;Plaintext&#39;: &#39;{&quot;not_before&quot;: &quot;20150914T172347Z&quot;, &quot;not_after&quot;: &quot;20150914T182347Z&quot;}&#39;, u&#39;KeyId&#39;:</span>
<span class="go">u&#39;arn:aws:kms:us-east-1:12345:key/abcdefgh-1234-5678-9abcd-ee72ac95ae8c&#39;,</span>
<span class="go">&#39;ResponseMetadata&#39;: {&#39;HTTPStatusCode&#39;: 200, &#39;RequestId&#39;:</span>
<span class="go">&#39;6450392b-072d-11e5-87df-5345698b39e1&#39;}}</span>
</pre></div>
</div>
<p>Notice that we could encrypt something and then decrypt it, as long as we
passed in the same context.</p>
<p>Now let’s change the encryption context slightly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; kms.decrypt(
&gt;&gt;&gt;     CiphertextBlob=token[&#39;CiphertextBlob&#39;],
&gt;&gt;&gt;     EncryptionContext={
&gt;&gt;&gt;         &#39;from&#39;: &#39;notmyservice-production&#39;,
&gt;&gt;&gt;         &#39;to&#39;: &#39;confidant-production&#39;,
&gt;&gt;&gt;         &#39;user_type&#39;: &#39;service&#39;
&gt;&gt;&gt;     }
&gt;&gt;&gt; )
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;/home/rlane/Envs/boto3/lib/python2.7/site-packages/botocore/client.py&quot;,
line 249, in _api_call
    raise ClientError(parsed_response, operation_name)
botocore.exceptions.ClientError: An error occurred (InvalidCiphertextException)
when calling the Decrypt operation: None
</pre></div>
</div>
<p>Note that there’s a couple reasons this would fail:</p>
<ol class="arabic simple">
<li><p>The ‘from’ context passed into this decryption action doesn’t match the ‘from’
context that was used during the encryption action.</p></li>
<li><p>This service isn’t allowed to do a decryption action with the provided
‘from’ context, since the grant is limiting the ‘from’ context to
‘myservice-production’.</p></li>
</ol>
<p>Let’s take a look at how to implement an authentication flow using this on the
server and the client. Here’s the server side (using flask):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_key_arn</span><span class="p">():</span>
    <span class="c1"># You should cache this.</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">kms</span><span class="o">.</span><span class="n">describe_key</span><span class="p">(</span>
        <span class="n">KeyId</span><span class="o">=</span><span class="s1">&#39;alias/{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MASTER_KEY_ID&#39;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">[</span><span class="s1">&#39;KeyMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;Arn&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_parse_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">username_arr</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">username_arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># V2 token format: version/service/myservice or version/user/myuser</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">username_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">user_type</span> <span class="o">=</span> <span class="n">username_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">username_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">username_arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Old format, specific to services: myservice</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">username_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">user_type</span> <span class="o">=</span> <span class="s1">&#39;service&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TokenVersionError</span><span class="p">(</span><span class="s1">&#39;Unsupported username format.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">version</span><span class="p">,</span> <span class="n">user_type</span><span class="p">,</span> <span class="n">username</span>

<span class="k">def</span> <span class="nf">decrypt_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="n">version</span><span class="p">,</span> <span class="n">user_type</span><span class="p">,</span> <span class="n">_username</span> <span class="o">=</span> <span class="n">_parse_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">kms</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
            <span class="n">CiphertextBlob</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">EncryptionContext</span><span class="o">=</span><span class="p">{</span>
                <span class="c1"># This token is sent to us.</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;IAM_ROLE&#39;</span><span class="p">],</span>
                <span class="c1"># From another service.</span>
                <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">_username</span><span class="p">,</span>
                <span class="s1">&#39;user_type&#39;</span><span class="p">:</span> <span class="n">user_type</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Decrypt doesn&#39;t take KeyId as an argument. We need to verify the</span>
        <span class="c1"># correct key was used to do the decryption.</span>
        <span class="c1"># Annoyingly, the KeyId from the data is actually an arn.</span>
        <span class="n">key_arn</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;KeyId&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key_arn</span> <span class="o">!=</span> <span class="n">get_key_arn</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">TokenDecryptError</span><span class="p">(</span><span class="s1">&#39;Authentication error.&#39;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Plaintext&#39;</span><span class="p">])</span>
    <span class="c1"># We don&#39;t care which exception is thrown. If anything fails, we fail.</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TokenDecryptError</span><span class="p">(</span><span class="s1">&#39;Authentication error.&#39;</span><span class="p">)</span>
    <span class="n">time_format</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%SZ&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">not_before</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;not_before&#39;</span><span class="p">),</span> <span class="n">time_format</span><span class="p">)</span>
        <span class="n">not_after</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;not_after&#39;</span><span class="p">),</span> <span class="n">time_format</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TokenDecryptError</span><span class="p">(</span><span class="s1">&#39;Authentication error.&#39;</span><span class="p">)</span>
    <span class="c1"># Ensure the token is within the validity window.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">not_before</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">not_after</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">TokenDecryptError</span><span class="p">(</span><span class="s1">&#39;Authentication error.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span>


<span class="k">def</span> <span class="nf">require_auth</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">keymanager</span><span class="o">.</span><span class="n">decrypt_token</span><span class="p">(</span>
                <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">],</span>
                <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-From&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># We could do additional checks here, based on the payload</span>
            <span class="c1"># contents, like check for scope passed in.</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TokenDecryptError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
        <span class="c1"># Paranoia</span>
        <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated</span>
</pre></div>
</div>
<p>And here’s the client side (using requests):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">not_after</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">not_before</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%SZ&quot;</span><span class="p">)</span>
<span class="n">not_after</span> <span class="o">=</span> <span class="n">not_after</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%SZ&quot;</span><span class="p">)</span>
<span class="n">auth_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;servicea-development&#39;</span><span class="p">,</span>
    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;serviceb-development&#39;</span><span class="p">,</span>
    <span class="s1">&#39;user_type&#39;</span><span class="p">:</span> <span class="s1">&#39;service&#39;</span>
<span class="p">}</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="s1">&#39;{&quot;not_before&quot;: &quot;{0}&quot;, &quot;not_after&quot;: &quot;{1}&quot;}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">not_before</span><span class="p">,</span> <span class="n">not_after</span><span class="p">)</span>
<span class="n">kms</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;kms&#39;</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">kms</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
    <span class="n">KeyId</span><span class="o">=</span><span class="s1">&#39;alias/authnz-testing&#39;</span><span class="p">,</span>
    <span class="n">Plaintext</span><span class="o">=</span><span class="n">plaintext</span><span class="p">,</span>
    <span class="n">EncryptionContext</span><span class="o">=</span><span class="n">auth_context</span>
<span class="p">)[</span><span class="s1">&#39;CiphertextBlob&#39;</span><span class="p">]</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
    <span class="c1"># version: 2, user_type: service, username (2/service/username)</span>
    <span class="s1">&#39;X-Auth-From&#39;</span><span class="p">:</span> <span class="s1">&#39;2/service/{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auth_context</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
<span class="p">}</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/v1/services/servicea-development&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>
</div>
<p>This is almost exactly the server and client auth flow used in Confidant. This
same pattern can be applied for doing your own service-to-service
authentication as well.</p>
<p>Something to notice here is that we’re doing extra work based on the payload
contents of the token. We’re adding <code class="docutils literal notranslate"><span class="pre">not_before</span></code> and <code class="docutils literal notranslate"><span class="pre">not_after</span></code> data so that we can
give this token a lifetime. The client is specifying the lifetime of the token
itself. You could put additional information into the payload, such as token
scope, additional contraints, etc.. In Confidant, on the server side we also
limit the maximum lifetime of a token, to ensure clients are occasionally
rotating their authentication tokens.</p>
<div class="section" id="iam-policy-configuration-for-service-to-service-auth">
<h3>IAM policy configuration for service-to-service auth<a class="headerlink" href="#iam-policy-configuration-for-service-to-service-auth" title="Permalink to this headline">¶</a></h3>
<p>If you wish to disable grant management for KMS auth, it’s possible to manage
IAM policy for service-to-service authentication. An assumption of this example
is that a confidant service (serviceA-production) maps directly to an IAM role
(serviceA-production) and your confidant service is confidant-production. Let’s
add a policy to the service, to allow authentication:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;kms:GenerateRandom&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;kms:Encrypt&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;arn:aws:kms:us-east-1:12345:key/your-authnz-key-id&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Condition&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;kms:EncryptionContext:to&quot;</span><span class="p">:</span> <span class="s2">&quot;confidant-production&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;kms:EncryptionContext:user_type&quot;</span><span class="p">:</span> <span class="s2">&quot;service&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;kms:EncryptionContext:from&quot;</span><span class="p">:</span> <span class="s2">&quot;serviceA-production&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="passing-encrypted-data-between-services">
<h2>Passing encrypted data between services<a class="headerlink" href="#passing-encrypted-data-between-services" title="Permalink to this headline">¶</a></h2>
<p>In the service-to-service section we actually passed encrypted
content between two services; however, we used KMS’s Encrypt action
directly, which is limited to 4 KB of data. If all you need to do is pass
messages smaller than 4KB, this will work perfectly for you. If you need to
pass more than 4KB, you’ll need to generate data keys, and do a bit of
encryption yourself, using the data key.</p>
<p>Confidant does this using the cryptography.io Python library and its Fernet
implementation. It doesn’t matter which language or library you use, the steps
are basically the same:</p>
<ol class="arabic simple">
<li><p>Generate a data key, with context: {‘from’: ‘servicea-production’, ‘to’:
‘serviceb-production’, ‘user_type’: ‘service’}</p></li>
<li><p>Use the Plaintext portion the data key to encrypt your data.</p></li>
<li><p>Pass the CiphertextBlob portion of the data key along with the data to the
other service.</p></li>
<li><p>The other service should decrypt the CiphertextBlob portion of the data key,
giving it the Plaintext portion.</p></li>
<li><p>The other service will use the Plaintext portion of the data key to decrypt
the data.</p></li>
</ol>
</div>
<div class="section" id="user-to-service-authentication">
<h2>User-to-service authentication<a class="headerlink" href="#user-to-service-authentication" title="Permalink to this headline">¶</a></h2>
<p>Confidant does not setup grants for user authentication. To enable user to service
KMS authentication, it’s necessary to setup IAM policy for your KMS keys. Thankfully,
the IAM policy for this is pretty straightforward:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;kms:GenerateRandom&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;kms:Encrypt&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;arn:aws:kms:us-east-1:12345:key/your-authnz-key-id&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Condition&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;kms:EncryptionContext:to&quot;</span><span class="p">:</span> <span class="s2">&quot;confidant-production&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;kms:EncryptionContext:user_type&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;kms:EncryptionContext:from&quot;</span><span class="p">:</span> <span class="s2">&quot;${aws:username}&quot;</span>
                <span class="p">},</span>
                <span class="nt">&quot;Bool&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;aws:MultiFactorAuthPresent&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This policy allows a user to generate KMS authentication tokens, as long as the
‘from’ context matches their IAM user name, the ‘to’ context is to ‘confidant-production’
and the ‘user_type’ is ‘user’. Note that if you wanted to allow authentication from users
to any service, you can change the second statement slightly:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;kms:Encrypt&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;arn:aws:kms:us-east-1:12345:key/your-authnz-key-id&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;Condition&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;StringLike&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;kms:EncryptionContext:to&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;kms:EncryptionContext:user_type&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="nt">&quot;kms:EncryptionContext:from&quot;</span><span class="p">:</span> <span class="s2">&quot;${aws:username}&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;aws:MultiFactorAuthPresent&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the user authenticates, they’ll use a header like: <code class="docutils literal notranslate"><span class="pre">'X-Auth-From':</span> <span class="pre">'2/user/rlane'</span></code>.
From the server side, you’ll be able to verify the token, then you can mark the user
by user_type, so that you can do access control based on their type (service or user).</p>
</div>
<div class="section" id="multi-account-kms-authentication">
<h2>Multi-account KMS authentication<a class="headerlink" href="#multi-account-kms-authentication" title="Permalink to this headline">¶</a></h2>
<p>Without much change it’s possible to do KMS authentication across accounts. In
the simplest approach, you can simply allow multiple accounts to use the KMS
authnz key. The downside to this is that when you allow another account to use
the KMS key, you’re trusting that account with the IAM policy of whichever
actions you’re allowing. So, if you have two accounts: sandbox and production,
and you allow sandbox to use the KMS authnz key in production, sandbox can
write IAM policies that allow it to generate tokens for any service in
confidant, which may not be what you intend.</p>
<p>Starting in version 1.1, Confidant added support for using scoped KMS
authentication keys. Rather than using a single KMS authentication key for all
accounts, you’ll create a KMS key for each account. The key policy for each key
will allow its specific account to use the key. Note that it’s important that
all of these keys live in the same AWS account as the confidant service.</p>
<p>After creating and configuring the keys, you can use the SCOPED_AUTH_KEYS
setting in confidant to map key aliases to friendly account names. Once this is
configured, users can scope services to accounts.</p>
<p>If you’re implementing KMS auth outside of confidant: we map keys to account
names. When a token is decrypted, part of what KMS returns is the key ARN used
for the decryption. We take that ARN and lookup the alias that’s associated with
it. We take the alias and look it up in the SCOPED_AUTH_KEYS mapping to find its
associated account. If the scoped service matches the key used, we accept the
request.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="threat_model.html" class="btn btn-neutral float-right" title="Threat model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="blind_secrets.html" class="btn btn-neutral float-left" title="Server-blinded secrets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2020, Confidant Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>